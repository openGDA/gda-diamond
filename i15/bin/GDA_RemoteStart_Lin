#!/bin/bash

# Start log panel if not already started
LOGPANEL=$(ps -ef | grep LogPanel | grep -v grep)
if [ "X$LOGPANEL" == "X" ] ; then
  echo Starting GDA Log Panel...
  GDA_StartLogPanel
else
  echo Raising GDA Log Panel...
  wmctrl -R "GDA Log Panel"
fi

echo Making sure we want to restart GDA servers now...
echo

zenity --title "Are you sure?" --question --text "Are you sure you want to restart the GDA servers?" --window-icon=question
SURE=$?
if [ $SURE == 1 ]; then
  exit
fi

##This is an example script file to restart GDA server from a remote client
##This requires generation of ssh keys and copying the public key to the authorized_keys file in the server
##Please refer to the document howtoSSH.txt for key generation.
##To use this script change the key file path, user name and the server machine name

echo
echo "Restarting the GDA Server, please wait..."
echo
echo "Keep this window open, and you will see a pop-up when the restart has completed"
echo

grep "i15-control" ~/.ssh/known_hosts > 2&>1 /dev/null
OK=$?	# 0 if ok, 2 if file doesn't exist, 1 if file doesn't contain pattern

if [ $OK != 0 ]; then
	echo i15-control not in ~/.ssh/known_hosts, adding...
	echo i15-control.diamond.ac.uk,172.23.115.32 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAzJZZ0/24hraQavEZEHlG+u8Aitw43YzDLUTd9i/BHHS5KuIiLUgaQV/gn2EnE3Oscd9u/JFUmKUNZESUTYGe6s07/YrdbpGZavBJvLrHkmmtFfOCCVemILZJDqzG2iIxqz9MVznMVf5ctSbqCOE1z+aR/AfcWUuP2LsrRtZ1mQzjRV21Fy+NGknPQ8d4aOY7phQfWQLqWKDM63JdCP3ZcnIWA+53QUt5Trrjty8fG/aah4at8gMyvZjAQHrR/CcVA2MB9OjkaTs2gCm0nNXGKxKJk4/pXCwAXYoWKLynSiHMaz1xl7hNjzTPvKzM65F60pigIz3137PKuXv8WWBZDQ== >> ~/.ssh/known_hosts
	echo 
fi

ssh  -i /dls_sw/i15/software/gda/i15-config/i15ssh.key gda@i15-control.diamond.ac.uk
OK=$?

# 127 if ssh cannot run command, 0 if ran ok, maybe other values if remote command returns them

if [ $OK != 0 ]; then
  zenity --title "Error starting GDA Server" --error --text "Something went wrong starting GDA server. Please try logging out and back in again before contacting your GDA representative." 
  exit
fi
#
# wait for the remote command, which will look for the output file which will
# tell us when the servers have started before returning, then display to the
# user that a client may be started.
#
echo
echo Making sure we want to start GDA client now...
echo

zenity --title "Start the Client?" --question --text "The GDA servers have restarted. Click OK to start the GDA Client." --window-icon=question
STARTCLIENT=$?
if [ $STARTCLIENT == 0 ]; then
  echo Starting new GDA RCP Client...
  GDA_StartRCP
  if [ "X$LOGPANEL" == "X" ] ; then
    echo
    echo Moving GDA Log Panel to ...
    wmctrl -r "GDA Log Panel" -e 0,1921,0,1000,1000
  fi
fi

echo
echo Fix the OD PC issues
echo
rdesktop -T "OD PC" -5 -a 16 -u i15detector -p \!i15d3t3ct0r# -d DIAMOND -k en-gb -g 1850x1150 i15-rubiccd01 &

WINDOWTITLE="Please restart IS"
(sleep 2; wmctrl -a "$WINDOWTITLE")& # bring zenity to front after 2 secs.
zenity --title "$WINDOWTITLE" --info --text "\
Due to a problem with the Oxford Diffraction software, the GDA server cannot\
 reconnect to the IS application automatically when it restarts.\n
When this happens the fast shutter will not open for *any* detector.\n
To correct this, please use the remote desktop just opened \
('OD PC' in your Window List) to:\n
1. Close the IS application ('CMD: root' in the task bar).\n
2. Restart the IS application (by clicking on the yellow diffractometer\
 icon in the quick launch bar, near the start menu, which has the tooltip\
 'Shortcut to is_win32_2.1.1936_18A_Release.exe'.\n
3. Disconnect from the OD PC by closing the 'OD PC' window.\n
Once the GDA Client has restarted, you can tell GDA it is now safe to \
reconnect to IS by running:\n
  atlas.connect()\n
at the Jython Terminal."

echo
for i in {10..1}; do echo -n . ; sleep 1 ; done ; echo .