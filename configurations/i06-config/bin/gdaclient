#!/bin/bash

export GDA_ROOT=$(readlink -f $(dirname $0)/../../../../..)

if [ "$GDA_MODE" = "i06" -o "$GDA_MODE" = "i06-1" ]; then
	. $GDA_ROOT/workspace_git/gda-mt.git/configurations/mt-config/bin/gda_setup_env gda_client_output
	VMARGS="-Dgda.logs.dir=/dls_sw/$BEAMLINE/logs"
else
	. $GDA_ROOT/workspace_git/gda-mt.git/configurations/mt-config/bin/gda_setup_env gda_client_output_$GDA_MODE
	VMARGS="-Dgda.logs.dir=/dls_sw/$BEAMLINE/logs/$GDA_MODE"
fi

# i06 & i06-1 all share the same i06-config directory, so overrride the one from gda_setup_env
export GDA_CONFIG=$GDA_ROOT/workspace_git/gda-mt.git/configurations/i06-config

VMARGS="-Djacorb.config.dir=$GDA_CONFIG/properties/jacorb_$GDA_MODE                                $VMARGS"
VMARGS="-Dgda.propertiesFile=$GDA_CONFIG/properties/java.properties_$GDA_MODE                      $VMARGS"
VMARGS="-Dgov.aps.jca.JCALibrary.properties=$GDA_CONFIG/properties/JCALibrary.properties_$GDA_MODE $VMARGS"
VMARGS="-Dgda.data=/dls/$BEAMLINE $VMARGS"
# VAR? like  ARGS="--vardir     $GDA_ROOT/../var $ARGS"
#VMARGS="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=127.0.0.1:8001 $VMARGS"

EXTENDED_MEMORY="-Xms128m -Xmx2048m -XX:MaxPermSize=256m"
ENABLE_JMX_REMOTE="-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.port=7091 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
ENABLE_FLIGHT_RECORDER="-XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true"
CONFIG_RECORDING="-XX:StartFlightRecording=duration=24h,filename=objectserverrecording.jfr"
RECORDING_ON_EXIT="-XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true,dumponexitpath=/tmp"
GARBAGE_COLLECTION="-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:/tmp/gc.log -XX:+DisableExplicitGC"
ERROR_FILE="-XX:ErrorFile=/tmp/hs_err_pid%p.log"
HEAP_DUMP="-XX:-HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/gdaclient.hprof"
BIASED_LOCKING=" -XX:-UseBiasedLocking -XX:+PrintSafepointStatistics"

export GDA_CLIENT_VMARGS="$EXTENDED_MEMORY $ENABLE_FLIGHT_RECORDER $GARBAGE_COLLECTION $ERROR_FILE $HEAP_DUMP $BIASED_LOCKING $VMARGS
#echo  GDA_CLIENT_VMARGS=$VMARGS
export GDA_CLIENT=$GDA_ROOT/client/gda-$BEAMLINE

$GDA_CLIENT_SCRIPT --keep --nohup $GDA_CONSOLE_LOG $*
