#!/bin/bash
##This is the script file to restart GDA servers on a local workstation

if [ ! -n "$BEAMLINE" ];
then
  echo "Please set BEAMLINE environment variable."
  exit 1
fi

DebugPort=8000

mkdir -p  /tmp/gda/var/
mkdir -p  /tmp/gda/logs/

export gdaLauncher=/dls_sw/$BEAMLINE/software/gda_git/gda-core.git/uk.ac.gda.core/bin/gda


configDir=/dls_sw/$BEAMLINE/software/gda/i06-config
varDir=/tmp/gda/var
dataDir=/tmp/gda
logDir=/tmp/gda/logs

Properties=$configDir/properties/java.properties_local 
JacorbDir=$configDir/properties/jacorb_local

echo Kill all GDA Clients running locally
$gdaLauncher --stop client
sleep 2;

echo Stop all server
$gdaLauncher --stop nameserver
$gdaLauncher --stop logserver
$gdaLauncher --stop eventserver
$gdaLauncher --stop objectserver

 
echo Restarting all GDA servers locally

echo Start the Name Server
$gdaLauncher --config=$configDir --properties=$Properties --jacorb=$JacorbDir --vardir=$varDir --datadir=$dataDir --logsdir=$logDir nameserver

echo Start the Log Server
$gdaLauncher --config=$configDir --properties=$Properties --jacorb=$JacorbDir --vardir=$varDir --datadir=$dataDir --logsdir=$logDir logserver

echo Start the Event Server
$gdaLauncher --config=$configDir --properties=$Properties --jacorb=$JacorbDir --vardir=$varDir --datadir=$dataDir --logsdir=$logDir eventserver


echo Start the Object Server
JAVA_OPTS="-Xms128m -Xmx4096m -XX:MaxPermSize=128m -XX:+DisableExplicitGC" $gdaLauncher -v --debug --debugport=$DebugPort --config=$configDir --properties=$Properties --jacorb=$JacorbDir --vardir=$varDir --datadir=$dataDir --logsdir=$logDir objectserver > $varDir/gda_output.txt 2>&1 &

sleep 2;

echo Waiting server starting...
## show log until 'Server initialisation complete' is seen
PIP=/tmp/`basename $0`-$$
mknod $PIP p
tail -n 1 -f $varDir/gda_output.txt >  $PIP &
awk '{
        if (!/DEBUG/) print ;
        if (/Server initialisation complete. xmlFile/) {
                print "\n\033[4;32m  All GDA servers are running, you can start the client now. \033[0m\n"
                exit ;
        }
}' < $PIP

#echo -e "\033[1;32mAll GDA servers are running, you can start the client now\033[1;0m\n"

tailPID=`ps ux | awk '/tail/ && !/awk/ {print $2}'`
killall $tailPID > /dev/null 2>&1
sleep 3
rm -f $PIP
