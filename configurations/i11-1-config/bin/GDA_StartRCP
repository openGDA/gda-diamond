#!/bin/bash

if [ ! -n "$BEAMLINE" ];
then
  echo "This command can only be run on beamline workstation. You are not on a beamline workstation."
  exit 1
fi

notify-send -t 10000 "GDA RCP Client is starting..."

. /$SOFTWAREFOLDER/$BEAMLINE/software/gda/config/bin/gda_environment.sh

if [ -f "/etc/profile.d/modules.sh" ]; then
	. /etc/profile.d/modules.sh	
	module load java/gda844
else
	echo "cannot source /etc/profile.d/modules.sh"	
	exit 1
fi

# Start log panel if not already started
LOGPANEL=$(ps -ef | grep gdalogpanel | grep -v grep)
if [ "X$LOGPANEL" == "X" ] ; then
	nohup GDA_StartLogPanel 2>/dev/null &
else
	wmctrl -R "GDA Log Panel"
fi

##Set default printer
lpoptions -d b.i11.cc2.col.1 -o job-sheets=none,none

EXTENDED_MEMORY="-Xms128m -Xmx2048m -XX:MaxPermSize=256m"
ENABLE_JMX_REMOTE="-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.port=7091 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
ENABLE_FLIGHT_RECORDER="-XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true"
CONFIG_RECORDING="-XX:StartFlightRecording=duration=24h,filename=objectserverrecording.jfr"
RECORDING_ON_EXIT="-XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true,dumponexitpath=/tmp"
GARBAGE_COLLECTION="-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:/tmp/gc.log -XX:+DisableExplicitGC -XX:+UseGCOverheadLimit -XX:-UseParallelGC -XX:ParallelGCThreads=8"
ERROR_FILE="-XX:ErrorFile=/tmp/hs_err_pid%p.log"
HEAP_DUMP="-XX:MaxHeapFreeRatio=70 -XX:-HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/gdaclient.hprof"

if [ -n "$JAVA_OPTS" ] ; then
	export JAVA_OPTS="$EXTENDED_MEMORY $ENABLE_FLIGHT_RECORDER $GARBAGE_COLLECTION $ERROR_FILE $HEAP_DUMP $JAVA_OPTS"
else
	export JAVA_OPTS="$EXTENDED_MEMORY $ENABLE_FLIGHT_RECORDER $GARBAGE_COLLECTION $ERROR_FILE $HEAP_DUMP"
fi

#`dirname $0`/gda_command rcpclient --rcp_image=/$SOFTWAREFOLDER/$BEAMLINE/software/gda/client/gda-${BEAMLINE} --restart $@ #--debug --debugport=8001 $@

#To run the RCP client directly
/$SOFTWAREFOLDER/${BEAMLINE}/software/gda/client/gda-${BEAMLINE} $@ & 

if [ "X$LOGPANEL" == "X" ] ; then
	sleep 5
	wmctrl -r "GDA Log Panel" -e 0,1921,0,1000,1000
fi

