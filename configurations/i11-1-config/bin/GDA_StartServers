#!/bin/bash
if [ -f "/etc/profile.d/modules.sh" ]; then
	. /etc/profile.d/modules.sh	
	module load java/gda844
else
	echo "cannot source /etc/profile.d/modules.sh"	
	exit 1
fi

`dirname $0`/gda_command nameserver --stop $@
`dirname $0`/gda_command eventserver --stop $@
`dirname $0`/gda_command objectserver --stop $@
`dirname $0`/gda_command logserver --stop $@

`dirname $0`/gda_command logserver $@
`dirname $0`/gda_command nameserver $@
`dirname $0`/gda_command eventserver $@

EXTENDED_MEMORY="-Xms256m -Xmx4096m -XX:MaxPermSize=256m"
ENABLE_JMX_REMOTE="-Dcom.sun.management.jmxremote=true -Dcom.sun.management.jmxremote.port=7091 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
ENABLE_FLIGHT_RECORDER="-XX:+UnlockCommercialFeatures -XX:+FlightRecorder -XX:FlightRecorderOptions=defaultrecording=true"
CONFIG_RECORDING="-XX:StartFlightRecording=duration=24h,filename=objectserverrecording.jfr"
RECORDING_ON_EXIT="-XX:FlightRecorderOptions=defaultrecording=true,dumponexit=true,dumponexitpath=/tmp"
GARBAGE_COLLECTION="-verbose:gc -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:/tmp/gc.log -XX:+DisableExplicitGC"
ERROR_FILE="-XX:ErrorFile=/tmp/hs_err_pid%p.log"
HEAP_DUMP="-XX:-HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/gdaobjectserver.hprof"

if [ -n "$JAVA_OPTS" ] ; then
	export JAVA_OPTS="$EXTENDED_MEMORY $ENABLE_JMX_REMOTE $ENABLE_FLIGHT_RECORDER $GARBAGE_COLLECTION $ERROR_FILE $HEAP_DUMP $JAVA_OPTS"
else
	export JAVA_OPTS="$EXTENDED_MEMORY $ENABLE_JMX_REMOTE $ENABLE_FLIGHT_RECORDER $GARBAGE_COLLECTION $ERROR_FILE $HEAP_DUMP"
fi

`dirname $0`/gda_command objectserver  --smart --trace --debug -p 8000 --restart -v --mode=live $@

#-XX:+UseConcMarkSweepGC -XX:MinHeapFreeRatio=25 -XX:NewRatio=2