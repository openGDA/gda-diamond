#!/bin/bash

LOGPANELWINDOW=$(wmctrl -l | grep "GDA Log Panel" | grep -v grep)
#echo LOGPANELWINDOW=$LOGPANELWINDOW

if [ "$LOGPANELWINDOW" == "" ] ; then
  #echo Log window not found, checking for log window process...

  LOGPANELPROCESS=$(ps -ef | grep LogPanel | grep -v grep)
  #echo LOGPANELPROCESS=$LOGPANELPROCESS

  if [ "$LOGPANELPROCESS" != "" ] ; then
    #echo Log process found

    LOGPANELUSER=$(echo $LOGPANELPROCESS | awk '{print $1}')
    #echo LOGPANELUSER=$LOGPANELUSER

    if [ $LOGPANELUSER == $USER ] ; then
      zenity --title "Are you sure?" --question --text "The log panel is already running on another display, do you want to attempt to run it on this display instead?\n\nIf you get a binding error close that LogPanel and open another one." --window-icon=question

      SURE=$?
      if [ $SURE == 0 ]; then # 0=Ok, 1=Cancel
        LOGPANELPID=$(echo $LOGPANELPROCESS | awk '{print $2}')
        echo Attempting to kill $LOGPANELPID
        kill $LOGPANELPID
      else
        exit 1
      fi
    else
      zenity --title "Unable to start Log Panel" --error --text "A Log Panel is already running as user '$LOGPANELUSER' on this machine ('$HOSTNAME'), possibly by remote desktop.\n\nPlease ask them to close their Log Panel before trying again.\n\nIf you cannot get in touch with '$LOGPANELUSER' then as a last resort you may want to consider rebooting this machine."
      exit 1
    fi
  fi
  . gda_setup_env gda_log_output

  echo Starting GDA Log Panel...
  echo GDA_CONFIG = $GDA_CONFIG , BEAMLINE = $BEAMLINE
  echo  $GDA_CORE_SCRIPT logpanel
  echo  $GDA_CORE_SCRIPT logpanel >> $GDA_CONSOLE_LOG
  nohup $GDA_CORE_SCRIPT logpanel >> $GDA_CONSOLE_LOG 2>&1 &

else
  echo Raising GDA Log Panel...
  wmctrl -R "GDA Log Panel"
fi
