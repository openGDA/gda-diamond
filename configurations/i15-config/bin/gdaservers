#!/bin/bash

if [ -z $GDA_MODE ] ; then
  export GDA_MODE=dummy
fi

export GDA_ROOT=$(readlink -f $(dirname $0)/../../../../..)

echo Ensure the Log panel is running...
$GDA_ROOT/workspace_git/gda-mt.git/configurations/$BEAMLINE-config/bin/gdalog

echo
echo Making sure we want to restart GDA servers now...
echo

zenity --title "Are you sure?" --question --text "Are you sure you want to restart the $GDA_MODE $BEAMLINE GDA servers?" --window-icon=question
SURE=$?
if [ $SURE == 1 ]; then # 0=Ok, 1=Cancel
  exit
fi

echo
echo "Restarting the GDA Server, please wait..."
echo
echo "Keep this window open, and you will see a pop-up when the restart has completed"
echo

# Correct GDA_VAR when running dummy mode
if [ "$GDA_MODE" = "dummy" ]; then
#	GDA_VAR=/scratch/dls_sw/i15/software/gda_versions/var
#KrisB - Change GDA_VAR path for my scratch
	GDA_VAR=$(readlink -f $GDA_ROOT/var)
	# Note that this should match with the gda.var value in properties/dummy/java.properties
else
	GDA_VAR=$(readlink -f $GDA_ROOT/../var)
fi

if [ -d $GDA_VAR ]; then
	export OBJECT_SERVER_STARTUP_FILE=$GDA_VAR/object_server_startup_server_main
	echo OBJECT_SERVER_STARTUP_FILE=$OBJECT_SERVER_STARTUP_FILE
else
	zenity --title "Error starting GDA Server" --error --text "$GDA_VAR does not exist. Please contact your GDA representative." 
	exit
fi

if [ "$GDA_MODE" = "live" ]; then
	
	##This is an example script file to restart GDA server from a remote client
	##This requires generation of ssh keys and copying the public key to the authorized_keys file in the server
	##Please refer to the document howtoSSH.txt for key generation.
	##To use this script change the key file path, user name and the server machine name
	
	echo
	echo Replacing known_host key for i15-control with a verified key.
	
	KNOWN_HOST="i15-control.diamond.ac.uk,172.23.115.32 ssh-rsa"
	KNOWN_HOST_KEY="AAAAB3NzaC1yc2EAAAABIwAAAQEAxBQz/PMsXiAUgmhcgUI9Gz+GsuxdogOoLdgk3SUzlk0Q2gGLxP7wBo8bR7oSn7PiZKy5ibmY4NmTMGWeia93IgUkksh6ID8srbnHm2q+uibJGQIWBHGIo88FVqxXP3kwcbXrJwPoLb9DZip/06ByJJ4ERs562PUt08lTfsfIJMy9d0flK+LN0Qn/WhaUOgFR5DCNe5MHnKnL6HdpUJw2UetKnD1NXwWN5uvFBgiIY8421p1gGeTX+OOocErptwZqO/sBX0jUdkzzRGXk4BZnxfKwxY2sGyuUos/ob63rds4iH+ljOTCORACk00FJvkdi8GFKsOlA/wGYkGoUcwVriw=="
	
	ssh-keygen -R i15-control.diamond.ac.uk &> /dev/null
	echo $KNOWN_HOST $KNOWN_HOST_KEY >> ~/.ssh/known_hosts
	
	# Work around problem with ssh where remotestartupscript.sh completes, but ssh doesn't return. 
	ssh -i /dls_sw/$BEAMLINE/software/gda/workspace_git/gda-mt.git/configurations/$BEAMLINE-config/${BEAMLINE}ssh.key gda2@$BEAMLINE-control.diamond.ac.uk &
	# Run in background and wait for OBJECT_SERVER_STARTUP_FILE here. Note that due to network filesystem this is *much* less responsive
	# but should start the client eventually, unlike ssh which may hand forever.
	
	# Prevent asking for passwords, just fail
	#  -o "BatchMode yes"
	# Don't use stdin: -n 
	#ssh -n -i /dls_sw/$BEAMLINE/software/gda/workspace_git/gda-mt.git/configurations/$BEAMLINE-config/${BEAMLINE}ssh.key gda2@$BEAMLINE-control.diamond.ac.uk
	#OK=$?
	#
	## 127 if ssh cannot run command, 0 if ran ok, maybe other values if remote command returns them
	#
	#if [ $OK != 0 ]; then
	#  zenity --title "Error starting GDA Server" --error --text "Something went wrong starting GDA server. Please try logging out and back in again before contacting your GDA representative." 
	#  exit
	#fi
else
	rm -f $OBJECT_SERVER_STARTUP_FILE
	
	$GDA_ROOT/workspace_git/gda-mt.git/configurations/$BEAMLINE-config/bin/GDA_StartServers --mode=dummy
fi

# look for the output file which will tell us when the servers have started
$GDA_ROOT/workspace_git/gda-mt.git/configurations/mt-config/bin/lookForFile $OBJECT_SERVER_STARTUP_FILE Client

#
# wait for the remote command, which will look for the output file which will
# tell us when the servers have started before returning, then display to the
# user that a client may be started.
#
echo
echo Making sure we want to start GDA client now...
echo

zenity --title "Start the Client?" --question --text "The GDA servers have restarted. Click OK to start the GDA Client." --window-icon=question
STARTCLIENT=$?
if [ $STARTCLIENT == 0 ] ; then # 0=Ok, 1=Cancel
  echo Starting GDA RCP Client...
  echo
  $GDA_ROOT/workspace_git/gda-mt.git/configurations/$BEAMLINE-config/bin/gdaclient &
  echo
  echo Moving GDA Log Panel...
  wmctrl -r "GDA Log Panel" -e 0,1921,0,1000,1000
  echo
  for i in {10..1}; do echo -n . ; sleep 1 ; done ; echo .
fi
