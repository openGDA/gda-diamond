#!/bin/bash

echo Ensure the Log panel is running...
gdalog-dummy

echo
echo Making sure we want to restart GDA servers now...
echo

zenity --title "Are you sure?" --question --text "Are you sure you want to restart the $BEAMLINE GDA servers?" --window-icon=question
SURE=$?
if [ $SURE == 1 ]; then # 0=Ok, 1=Cancel
  exit
fi

echo
echo "Restarting the GDA Server, please wait..."
echo
echo "Keep this window open, and you will see a pop-up when the restart has completed"
echo

. $(dirname "$0")/GDA_common gda_servers_output

GDA_VAR=$(readlink -f $GDA_ROOT/../var)
if [ -d $GDA_VAR ]; then
	export OBJECT_SERVER_STARTUP_FILE=$GDA_VAR/object_server_startup_server_main
	echo OBJECT_SERVER_STARTUP_FILE=$OBJECT_SERVER_STARTUP_FILE
else
	echo ERROR: $GDA_VAR does not exist.
	exit
fi
rm -f $OBJECT_SERVER_STARTUP_FILE

umask 0002 # Some voodoo copied from GDA-mt/configurations/i16-config/bin/remotestartupscript.sh at d024aae
# This should fix a problem where sub-directories created in a visit folder end up
# with a different mask to the default.

export JAVA_OPTS="-Dgda.deploytype=1 -XX:MaxPermSize=1024m" # Seems to fix the reset_namespace problem
GDA_CORE_SCRIPT_OPTIONS="--headless servers --debug --debugport=8001 --mode=dummy"

echo  $GDA_CORE_SCRIPT $GDA_CORE_SCRIPT_OPTIONS
echo  $GDA_CORE_SCRIPT $GDA_CORE_SCRIPT_OPTIONS >> $GDA_CONSOLE_LOG
nohup $GDA_CORE_SCRIPT $GDA_CORE_SCRIPT_OPTIONS >> $GDA_CONSOLE_LOG  2>&1 &

# look for the output file which will tell us when the servers have started

lookForFile $OBJECT_SERVER_STARTUP_FILE

#
# wait for the remote command, which will look for the output file which will
# tell us when the servers have started before returning, then display to the
# user that a client may be started.
#
echo
echo Making sure we want to start GDA client now...
echo

zenity --title "Start the Client?" --question --text "The GDA servers have restarted. Click OK to start the GDA Client." --window-icon=question
STARTCLIENT=$?
if [ $STARTCLIENT == 0 ] ; then # 0=Ok, 1=Cancel
  echo Starting GDA RCP Client...
  echo
  gdaclient-dummy &
  echo
  echo Moving GDA Log Panel...
  wmctrl -r "GDA Log Panel" -e 0,1921,0,1000,1000
  echo
  for i in {10..1}; do echo -n . ; sleep 1 ; done ; echo .
fi