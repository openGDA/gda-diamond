#!/bin/bash
##This is an example script file to restart GDA server from a remote workstation
##This requires generation of ssh keys and copying the public key to the authorized_keys file in the server
##Please refer to the document howtoSSH.txt for key generation.
##To use this script change the key file path, user name and the server machine name


if [ ! -n "$BEAMLINE" ];
then
  echo "Please set BEAMLINE environment variable."
  exit 1
fi

#export gdaLauncher=/dls_sw/$BEAMLINE/software/gda/plugins/uk.ac.gda.core/bin/gda
export gdaLauncher=/dls_sw/$BEAMLINE/software/gda_git/gda-core.git/uk.ac.gda.core/bin/gda

varDir=/dls_sw/$BEAMLINE/var
dataDir=/dls/$BEAMLINE
logDir=/dls_sw/$BEAMLINE/logs


echo Kill all GDA Clients running locally
#GDA_KillClients &
$gdaLauncher --stop client
sleep 2;

echo Staring GDA Log Panel locally
echo $gdaLauncher logpanel &
$gdaLauncher logpanel &
sleep 2
 
echo Starting GDA Servers remotely...
echo ssh -o StrictHostKeyChecking=false -i /dls_sw/$BEAMLINE/software/gda/i07-config/${BEAMLINE}ssh.key gda2@${BEAMLINE}-control.diamond.ac.uk
ssh -o StrictHostKeyChecking=false -i /dls_sw/$BEAMLINE/software/gda/i07-config/${BEAMLINE}ssh.key gda2@${BEAMLINE}-control.diamond.ac.uk

echo Waiting server starting...
## show log until 'Server initialisation complete' is seen
PIP=/tmp/`basename $0`-$$
mknod $PIP p
tail -n 1 -f ${logDir}/gda_server.log >  $PIP &
awk '{
        if (!/DEBUG/) print ;
        if (/Server initialisation complete. xmlFile/) {
                print "\n\033[4;32m  All GDA servers are running, you can start the client now. \033[0m\n"
                exit ;
        }
}' < $PIP

#echo -e "\033[1;32mAll GDA servers are running, you can start the client now\033[1;0m\n"

tailPID=`ps ux | awk '/tail/ && !/awk/ {print $2}'`
killall $tailPID > /dev/null 2>&1
sleep 3
rm -f $PIP
