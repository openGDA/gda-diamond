
#The Temperature-Voltage Lookup Table: Sensor# 29261 (for temp10):
#            (T , V)
tvPoints1 = ((13,0.013118361),
		(14,0.014667004),
		(15,0.016552593),
		(16,0.01881747),
		(17,0.021505768),
		(18,0.024663392),
		(19,0.028334233),
		(20,0.032557702),
		(21,0.037369731),
		(22,0.042803365),
		(23,0.048887792),
		(28,0.089686255),
		(33,0.148170331),
		(38,0.223257377),
		(43,0.312286319),
		(48,0.41217575),
		(53,0.520011763),
		(58,0.633230635),
		(63,0.749751737),
		(68,0.868007309),
		(73,0.986874015),
		(78,1.105570022),
		(83,1.223562836),
		(88,1.34049975),
		(93,1.45615393),
		(98,1.570388385),
		(100,1.61566626),
		(110,1.838401072),
		(120,2.055065039),
		(130,2.265873963),
		(140,2.47114607),
		(150,2.67121425),
		(160,2.866389406),
		(170,3.056947778),
		(180,3.243130321),
		(190,3.425146667),
		(200,3.603180895),
		(210,3.777397288),
		(220,3.947944637),
		(230,4.114959799),
		(240,4.278569476),
		(250,4.43889128),
		(260,4.59603408),
		(270,4.750097675),
		(280,4.901110542),
		(290,5.049280314),
		(300,5.194764318),
		(310,5.337632821),
		(320,5.477954077),
		(330,5.615758796),
		(340,5.751146822),
		(350,5.884145422),
		(360,6.014882763),
		(370,6.143381553),
		(380,6.269664539),
		(390,6.393818997),
		(400,6.515928609),
		(410,6.635979482),
		(420,6.754083411),
		(430,6.870225088),
		(440,6.98451157),
		(450,7.096926298),
		(460,7.207571904),
		(470,7.316459697),
		(480,7.423629851),
		(490,7.52912132),
		(500,7.632971882),
		(510,7.735245718),
		(520,7.835922975),
		(530,7.935092906),
		(540,8.032761492),
		(550,8.128961276),
		(560,8.223749766),
		(570,8.31710554),
		(580,8.409109941),
		(590,8.499766057),
		(600,8.589102074),
		(610,8.677169825),
		(620,8.763946796),
		(630,8.849507505),
		(640,8.933829099),
		(650,9.016983621),
		(660,9.098971049),
		(670,9.179814609),
		(680,9.25955953),
		(690,9.338182351),
		(700,9.415727369),
		(710,9.492237368),
		(720,9.567255011),
		(730,9.642144592),
		(740,9.715581394),
		(750,9.788039539),
		(760,9.859558177),
		(770,9.930092748),
		(780,9.999723119)
		)

#The Temperature-Voltage Lookup Table: Sensor# 29260 (for temp20):
#            (T , V)
tvPoints2 = ((13,0.013102431),
		(14,0.014655926),
		(15,0.016546725),
		(16,0.021510975),
		(17,0.021510975),
		(18,0.0246747),
		(19,0.028351938),
		(20,0.032582276),
		(21,0.037401647),
		(22,0.042843033),
		(23,0.04893574),
		(28,0.089783133),
		(33,0.148329209),
		(38,0.223490164),
		(43,0.312602461),
		(48,0.412582237),
		(53,0.520513068),
		(58,0.633829128),
		(63,0.75044814),
		(68,0.868801127),
		(73,0.98776393),
		(78,1.106554107),
		(83,1.224638904),
		(88,1.341665317),
		(93,1.45740649),
		(98,1.571725306),
		(100,1.617036274),
		(110,1.839930068),
		(120,2.056743163),
		(130,2.267691868),
		(140,2.473094958),
		(150,2.673286016),
		(160,2.868576349),
		(170,3.059242622),
		(180,3.245526318),
		(190,3.42763735),
		(200,3.605760232),
		(210,3.780059487),
		(220,3.950684259),
		(230,4.117771657),
		(240,4.281448619),
		(250,4.441833062),
		(260,4.599033947),
		(270,4.753151391),
		(280,4.904306014),
		(290,5.052662831),
		(300,5.198302855),
		(310,5.3376),
		(320,5.477954077),
		(330,5.615758796),
		(340,5.751146822),
		(350,5.884145422),
		(360,6.014882763),
		(370,6.143381553),
		(380,6.269664539),
		(390,6.393818997),
		(400,6.515928609),
		(410,6.635979482),
		(420,6.754083411),
		(430,6.870225088),
		(440,6.98451157),
		(450,7.096926298),
		(460,7.207571904),
		(470,7.316459697),
		(480,7.423629851),
		(490,7.52912132),
		(500,7.632971882),
		(510,7.735245718),
		(520,7.835922975),
		(530,7.935092906),
		(540,8.032761492),
		(550,8.128961276),
		(560,8.223749766),
		(570,8.31710554),
		(580,8.409109941),
		(590,8.499766057),
		(600,8.589102074),
		(610,8.677169825),
		(620,8.763946796),
		(630,8.849507505),
		(640,8.933829099),
		(650,9.016983621),
		(660,9.098971049),
		(670,9.179814609),
		(680,9.25955953),
		(690,9.338182351),
		(700,9.415727369),
		(710,9.492237368),
		(720,9.567255011),
		(730,9.642144592),
		(740,9.715581394),
		(750,9.788039539),
		(760,9.859558177),
		(770,9.930092748),
		(780,9.999723119)
		)




from time import sleep;
from Diamond.Utility.LookupTables import InterpolatedArray;
from Diamond.PseudoDevices.EpicsDevices import EpicsDeviceClass;
	
class VoltageTemperatureControllerClass(EpicsDeviceClass):
	def __init__(self, name, tvTable, pvSet, pvGet, pvStatus, strUnit, strFormat, timeout=None):
		EpicsDeviceClass.__init__(self, name, pvSet, pvGet, pvStatus, strUnit, strFormat, timeout);

		self.tvTable = tvTable;
		self.vtTable = tvTable.reverseTable();
		
		self.targetTemperature = None;
		self.deadband = 100.0;
		self.delay = 5;
		

	def setDeadband(self, deadband):
		self.deadband = deadband;
		
	def getDeadband(self):
		return self.deadband;
	
	def v2t(self, v):
		t=self.vtTable[v];
		print "Voltage = " + str(v) + " ---> Temperature = "+ str(t);
		return t;
		
	def t2v(self, t):
		v=self.tvTable[t];
		print "Temperature = " + str(t) + " ---> Voltage = "+ str(v);
		return v;
	
	def getPosition(self):
		voltage=EpicsDeviceClass.getPosition(self);
		temperature = self.vtTable[voltage];
		return temperature;

	def asynchronousMoveTo(self, new_temperature):
		self.targetTemperature = new_temperature;
		self.setTemperature(self.targetTemperature);
		sleep(self.delay);

	def setTemperature(self, new_temperature):
		new_voltage = self.tvTable[new_temperature];
		try:
			if self.timeout is None:
				self.chSet.caput(new_voltage);
			else:
				self.chSet.caput(new_voltage, self.timeout);
		except:
			print "Error setting voltage"

	def getTemperature(self):
		return self.getPosition();

	def isBusy(self):
		ct = self.getTemperature();
		if (ct >= self.targetTemperature-self.deadband) and (ct <= self.targetTemperature+self.deadband):#No status pv provided, so no status feedback necessary
			return False;
		else:
			return True;
		
	def toString(self):
		ct = self.getTemperature();
		cv = self.tvTable[ct];
		return "Current Temperature: " + str(ct) + "K, (Voltage: " + str(cv)+ " V, Deadband: +-" + str(self.deadband) + "K)";


################################################
tvTable1 = InterpolatedArray(tvPoints1);
tvTable2 = InterpolatedArray(tvPoints2);

pvVoltageSet = "BL07I-EA-TCTRL-01:SP:VOLTAGE"
pvVoltageGet1 = "BL07I-EA-TCTRL-01:SENS1:VOLTAGE:RBV"
pvVoltageGet2 = "BL07I-EA-TCTRL-01:SENS2:VOLTAGE:RBV"
exec("temp10=temp20=None");
temp10=VoltageTemperatureControllerClass('temp10', tvTable1, pvVoltageSet, pvVoltageGet1, None, 'K', '%.5f', timeout=None);
temp20=VoltageTemperatureControllerClass('temp20', tvTable2, pvVoltageSet, pvVoltageGet2, None, 'K', '%.5f', timeout=None);

