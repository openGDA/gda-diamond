#!/bin/bash

#
# To be run by the gda server to test if a netwroked version of da.server is running on the correct machine and restart if necessary
#

# login to i20xspress-0 
# TODO need the i20detector key from i20user
ssh i20detector@i20-xspress0

export numPorts=`netstat -ln | grep 0.0.0.0:1972 | wc -l`

if [ $numPorts -eq 1 ]; then
	exit 0
fi

export numDaserver=`ps -fa | grep da.server | wc -l`
if  [ $numDaserver -eq 1 ]; then
	cd xspress2_64element
	nohup da.server -log -port &
	exit 0
fi

# if get here then a da.server without port must be running

pkill da.server

numPorts=`netstat -ln | grep 0.0.0.0:1972 | wc -l`
while [ $numPorts -eq 1 ]
do
	sleep 5
	numPorts=`netstat -ln | grep 0.0.0.0:1972 | wc -l`
done

nohup da.server -log -port &
exit 0




