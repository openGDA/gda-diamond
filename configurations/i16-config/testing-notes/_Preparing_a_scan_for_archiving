================================================================================
					Preparing a scan for archiving here
================================================================================
							Live or scratch deployment
--------------------------------------------------------------------------------

SCRATCH=/scratch
# Above in both scratch and live, but only below in live
DEPLOYMENT=$SCRATCH/dls_sw/i16/software/gda
ARCHIVE=$DEPLOYMENT/config/testing-notes/example-eta-scan/_regression_testing

--------------------------------------------------------------------------------
							Live vs scratch data
--------------------------------------------------------------------------------

VISIT=$DEPLOYMENT/gda_data_non_live
# Above in scratch, but below in live
VISIT=/dls/i16/data/2023/cm33911-1

--------------------------------------------------------------------------------
							Baseline
--------------------------------------------------------------------------------

BASELINE=$DEPLOYMENT/config/testing-notes/example-eta-scan/971324 # For pil3
BASELINE=$DEPLOYMENT/config/testing-notes/example-eta-scan/979681 # For merlin
BASELINE=$DEPLOYMENT/config/testing-notes/example-eta-scan/985494 # For merlins
BASELINE=$DEPLOYMENT/config/testing-notes/example-eta-scan/1022133 # For pil3

--------------------------------------------------------------------------------
							Common setup
--------------------------------------------------------------------------------

module load msmapper/1.7
cd $VISIT

Plus for dummy mode, activemq-for-dummy and GDA AreaDetector Simulation as usual

	To quickly summarise current state

echo -e "\nARCHIVE=$ARCHIVE\nBASELINE=$BASELINE\nVISIT=$VISIT\nSCAN=$SCAN\n"

	To set the current scan as a new baseline

BASELINE=$VISIT/$SCAN

--------------------------------------------------------------------------------
								Scan Analysis
--------------------------------------------------------------------------------

	To set the current scan (may need to be run multiple times if scan failed):

ls -trsh | tail -10 ; SCAN=$((SCAN+1)) ; echo SCAN=$SCAN

	To generate the structure files:

ls -tr $SCAN* ; echo ; \
nxls    -a $SCAN.nxs > $SCAN.nxs.nxlsa ; \
nexus.tree $SCAN.nxs > $SCAN.nxs.tree ; \
echo ; \
grep "^  @file_name=" $SCAN.nxs.nxlsa || mv $SCAN.nxs.tree  $SCAN.nxs.ndw.tree ; \
grep "^  @file_name=" $SCAN.nxs.nxlsa && mv $SCAN.nxs.tree  $SCAN.nxs.nsd.tree ; \
grep "^  @file_name=" $SCAN.nxs.nxlsa || mv $SCAN.nxs.nxlsa $SCAN.nxs.ndw.nxlsa ; \
grep "^  @file_name=" $SCAN.nxs.nxlsa && mv $SCAN.nxs.nxlsa $SCAN.nxs.nsd.nxlsa ; \
echo ; echo $SCAN.nxs.n*

	To compare the current scan with a beamline ndw or nsd baseline

[ -e     $BASELINE.nxs.ndw.nxlsa ] && [ -e $SCAN.nxs.ndw.nxlsa ] && \
  kdiff3 $BASELINE.nxs.ndw.nxlsa           $SCAN.nxs.ndw.nxlsa   & \
[ -e     $BASELINE.nxs.ndw.nxlsa ] && [ -e $SCAN.nxs.nsd.nxlsa ] && \
  kdiff3 $BASELINE.nxs.ndw.nxlsa           $SCAN.nxs.nsd.nxlsa   & \
[ -e     $BASELINE.nxs.nsd.nxlsa ] && [ -e $SCAN.nxs.nsd.nxlsa ] && \
  kdiff3 $BASELINE.nxs.nsd.nxlsa           $SCAN.nxs.nsd.nxlsa   & \
[ -e     $BASELINE.nxs.ndw.tree  ] && [ -e $SCAN.nxs.ndw.tree ] && \
  kdiff3 $BASELINE.nxs.ndw.tree            $SCAN.nxs.ndw.tree   & \
[ -e     $BASELINE.nxs.ndw.tree  ] && [ -e $SCAN.nxs.nsd.tree ] && \
  kdiff3 $BASELINE.nxs.ndw.tree            $SCAN.nxs.nsd.tree   & \
[ -e     $BASELINE.nxs.nsd.tree  ] && [ -e $SCAN.nxs.nsd.tree ] && \
  kdiff3 $BASELINE.nxs.nsd.tree            $SCAN.nxs.nsd.tree   &

--------------------------------------------------------------------------------
						Processing a scan
--------------------------------------------------------------------------------

	To re-process data, or process data that wasn't automatically processed

rs_map -s 0.002 -o processing/ $SCAN.nxs > $SCAN.nxs.rs_map.log ; \
ll -tr $SCAN.* $SCAN*.nxlsa $SCAN*.tree ; ll -tr processing/$SCAN*

	This is the offline equivalent of

rs_map -s 0.002 -o /dls/i16/data/2023/mm34332-1/processing/ /dls/i16/data/2023/mm34332-1/1022133.nxs

--------------------------------------------------------------------------------
						Processing Analysis
--------------------------------------------------------------------------------

	To compare the log with the baseline log:

[ -e $SCAN.i16_msmapper.log ] && kdiff3 $BASELINE.i16_msmapper.log $SCAN.i16_msmapper.log & \
[ -e $SCAN.nxs.rs_map.log   ] && kdiff3 $BASELINE.nxs.rs_map.log   $SCAN.nxs.rs_map.log &

	To generate the structure files of the processed volume:

[ -e       processed/${SCAN}_msmapper.nxs ] && \
nxls    -a processed/${SCAN}_msmapper.nxs > ${SCAN}_msmapper.nxs.nxlsa && \
nexus.tree processed/${SCAN}_msmapper.nxs > ${SCAN}_msmapper.nxs.tree ; \
[ -e       processing/$SCAN-processed-volume-hkl.nxs ] && \
nxls    -a processing/$SCAN-processed-volume-hkl.nxs > $SCAN-processed-volume-hkl.nxs.nxlsa ; \
nexus.tree processing/$SCAN-processed-volume-hkl.nxs > $SCAN-processed-volume-hkl.nxs.tree ; \
ll -tr $SCAN.* $SCAN*.nxlsa $SCAN*.tree ; ll -tr processing/$SCAN*

--------------------------------------------------------------------------------
								Scan Archiving
--------------------------------------------------------------------------------

cp $SCAN.dat $SCAN*.nxlsa $SCAN*.tree $SCAN*.log $ARCHIVE

================================================================================