#!/bin/bash
##This script file restart remote GDA server and then GDA Client
##This requires generation of ssh keys and copying the public key to the authorized_keys file in the server
##Please refer to the document howtoSSH.txt for key generation.
##To use this script change the key file path, user name and the server machine name

zenity --title "Are you sure?" --question --text "Are you sure you want to restart the GDA servers?" --window-icon=question
SURE=$?
if [ $SURE == 1 ]; then
	exit
fi

SERVER_STARTUP_FILE=/$SOFTWAREFOLDER/$BEAMLINE/var/object_server_startup_server_main; export SERVER_STARTUP_FILE
# Added by Mark 26/1/10
rm -f $SERVER_STARTUP_FILE

SSHOPTS="-o StrictHostKeyChecking=no -o BatchMode=yes"

ssh-keygen -R $BEAMLINE-control.diamond.ac.uk 2> /dev/null
#sed -i -e "/$BEAMLINE-control/d" ~/.ssh/known_hosts
ssh $SSHOPTS -i /$SOFTWAREFOLDER/${BEAMLINE}/software/gda/config/${BEAMLINE}ssh.key gda2@${BEAMLINE}-control.diamond.ac.uk 

# Start log panel if not already started
LOGPANEL=$(ps -ef | grep LogPanel | grep -v grep)
if [ "X$LOGPANEL" == "X" ] ; then
	nohup GDA_StartLogPanel 2>/dev/null &
else
	wmctrl -R "GDA Log Panel"
fi
#
# look for the output file which will tell us when the servers have started, then display to the user that a client may be started.
#
echo "Restarting the GDA Server, please wait..."
echo "Keep this window open, and you will see a pop-up when the restart has completed"
echo
/$SOFTWAREFOLDER/$BEAMLINE/software/gda/config/bin/lookForFile $SERVER_STARTUP_FILE

zenity --title "Start the Client?" --question --text "The GDA servers have restarted. Click OK to start the GDA Client." --window-icon=question
STARTCLIENT=$?
if [ $STARTCLIENT == 0 ]; then
	if [ $1 == "rcp" ]; then
		nohup GDA_StartRCP
	else
		nohup GDA_StartClient
	fi	
	if [ "X$LOGPANEL" == "X" ] ; then
		wmctrl -r "GDA Log Panel" -e 0,1921,0,1000,1000
	fi
fi